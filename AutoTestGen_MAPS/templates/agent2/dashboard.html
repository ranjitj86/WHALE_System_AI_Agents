{% extends "base.html" %}

{% block title %}Agent 2 - SYS.2 Analysis{% endblock %}

{% block maps_assistant_content %}
<p>On this page, the SYS.2 Analysis Agent helps you analyze and structure the drafted requirements.</p>
<ul>
    <li><strong>SYS.1 Requirements:</strong> View the initial requirements from the Elicitation stage.</li>
    <li><strong>SYS.2 Requirements:</strong> See the requirements drafted and structured by the Analysis agent.</li>
    <li><strong>Requirement Dependencies:</strong> Visualize the relationships and dependencies between requirements.</li>
    <li><strong>Export Options:</strong> Export the analyzed requirements in various formats.</li>
</ul>
<p>Use this page to refine the structure and dependencies of your requirements.</p>
<hr>
<p>Need more detailed information?</p>
<p><a href="#" target="_blank">Link to Documentation (Placeholder)</a></p>
<p><a href="#" target="_blank">Link to Glossary (Placeholder)</a></p>
{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent 2: SYS.2 Requirement Drafting</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Add Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { padding-top: 70px; }
        .requirement-card {
            margin-bottom: 1rem;
        }
        .dependency-graph {
            height: 400px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .priority-badge {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        .agent-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 10px;
        }
        .agent-2-indicator {
            background-color: #28a745; /* Green color for Agent 2 */
        }
        /* Dark mode styles */
        body.dark-mode {
            background-color: #343a40; /* Dark background */
            color: #f8f9fa; /* Light text */
        }
        body.dark-mode .card {
            background-color: #454d55; /* Slightly lighter dark for cards */
            color: #f8f9fa; /* Light text for cards */
            border-color: #6c757d; /* Subtle border */
        }
        body.dark-mode .card-title {
            color: #f8f9fa; /* Ensure card titles are light */
        }
        body.dark-mode .list-group-item {
             background-color: #454d55; /* Match card background */
             color: #f8f9fa; /* Light text */
             border-color: #6c757d; /* Subtle border */
        }
        body.dark-mode .navbar {
             background-color: #212529 !important; /* Even darker navbar */
        }
         body.dark-mode .navbar-brand, body.dark-mode .nav-link {
             color: #f8f9fa !important; /* Light text for navbar items */
        }
        body.dark-mode .subtitle {
            color: #ced4da !important; /* Lighter gray for subtitle in dark mode */
        }
        body.dark-mode .text-muted {
            color: #ced4da !important; /* Lighter gray for muted text in dark mode */
        }
        /* Dark mode styles for modals */
        body.dark-mode .modal-content {
            background-color: #454d55; /* Dark background for modal content */
            color: #f8f9fa; /* Light text for modal */
        }
        body.dark-mode .modal-body {
            color: #f8f9fa; /* Ensure text in modal body is light */
        }
         body.dark-mode .modal-body a {
             color: #bbdaff; /* Lighter blue for links in dark mode modal */
         }
        body.dark-mode .modal-header, body.dark-mode .modal-footer {
            border-color: #6c757d; /* Subtle border for modal parts */
        }
         body.dark-mode .modal-body strong {
             color: #f8f9fa; /* Ensure strong text is light */
         }
        /* Dark mode specific styles for Agent 2 */
        body.dark-mode .dependency-graph {
            border-color: #6c757d; /* Subtle border for the graph container */
        }

        /* Styles for Active Navbar Link */
        .navbar .nav-link.active {
            font-weight: bold;
            color: #ffffff !important; /* White text for active link */
            background-color: #0d6efd !important; /* Bootstrap primary blue */
        }

        /* Dark mode adjustments for active navbar link */
        body.dark-mode .navbar .nav-link.active {
            color: #ffffff !important; /* White text for active link in dark mode */
            background-color: #0d6efd !important; /* Bootstrap primary blue */
        }

        /* Style for dropdowns in cards */
        .requirement-card .form-select {
            display: inline-block;
            width: auto; /* Adjust width based on content */
            vertical-align: middle; /* Align with surrounding text/elements */
        }

        /* Style for editable requirement text */
        .requirement-card [data-field="sys2_requirement"][contenteditable="true"] {
            background-color: #fff; /* White background for editing */
            color: #212529; /* Dark text for editing */
        }

        /* Styles for SYS.2 Requirements Table to fit on page */
        #sys2RequirementsTable {
            table-layout: fixed; /* Fix table layout to control column widths */
            width: 100%; /* Ensure table takes full width of its container */
        }

        #sys2RequirementsTable th,
        #sys2RequirementsTable td,
        #traceabilityTable th,
        #traceabilityTable td {
            overflow-wrap: break-word; /* Break long words */
            word-wrap: break-word; /* Deprecated, but good for compatibility */
             vertical-align: top; /* Align content to the top */
             padding: 0.5rem; /* Adjust padding */
        }

        /* Define widths for specific columns to make the table fit */
        #sys2RequirementsTable th:nth-child(1), /* SYS.1 Req. ID */
        #sys2RequirementsTable td:nth-child(1) {
            width: 8%;
        }
        #sys2RequirementsTable th:nth-child(3), /* SYS.2 Req. ID */
        #sys2RequirementsTable td:nth-child(3) {
            width: 8%;
        }
        #sys2RequirementsTable th:nth-child(5), /* Type */
        #sys2RequirementsTable td:nth-child(5) {
            width: 10%;
        }
         #sys2RequirementsTable th:nth-child(6), /* Verification Method */
         #sys2RequirementsTable td:nth-child(6) {
             width: 10%;
         }
        #sys2RequirementsTable th:nth-child(8), /* Domain */
        #sys2RequirementsTable td:nth-child(8) {
            width: 6%;
        }
        #sys2RequirementsTable th:nth-child(9), /* Priority - Added width */
        #sys2RequirementsTable td:nth-child(9) {
            width: 6%;
        }
        #sys2RequirementsTable th:nth-child(11), /* Requirement Status */
        #sys2RequirementsTable td:nth-child(11) {
            width: 6%;
        }
         #sys2RequirementsTable th:nth-child(12), /* Actions */
         #sys2RequirementsTable td:nth-child(12) {
             width: 8%;
         }

        /* Let SYS.1 Requirement (2), SYS.2 System Requirement (4), Verification Criteria (7), and Rationale (10) take remaining space */

        /* CSS for Collapsible Text */
        .collapsible-text-container {
            overflow: hidden;
            max-height: 4em; /* Adjust based on desired number of lines and line-height */
            transition: max-height 0.3s ease-in-out;
        }

        .collapsible-text-container.expanded {
            max-height: none; /* Show full content when expanded */
        }

        .show-more-toggle {
            display: block;
            margin-top: 0.5em; /* Space between text and toggle */
            cursor: pointer;
            color: #0d6efd; /* Bootstrap primary blue */
            text-decoration: underline;
        }
         .show-more-toggle:hover {
             color: #0b5ed7; /* Darker blue on hover */
         }

        /* Styles for the three main pie charts to ensure consistent size */
        #sys2StatusChart,
        #sys2TypeChart,
        #sys2VerificationChart,
        #sys2TraceabilityChart {
            max-width: 300px; /* Set a maximum width */
            max-height: 300px; /* Set a maximum height */
            margin: auto; /* Center the chart within its container */
        }

        /* Style to hide the traceability dashboard section initially */
        .hidden-dashboard-section {
            display: none;
        }

    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="d-flex align-items-center w-100">
            <a class="navbar-brand me-0" href="/">[WHALE-RE]: Home</a>
            <div class="navbar-nav d-flex flex-row ms-0">
                <a class="nav-link px-2 {% if request.path == '/agent/1' %}active{% endif %}" href="/agent/1">SYS.1 Elicitation</a>
                <a class="nav-link px-2 {% if request.path == '/agent/2' %}active{% endif %}" href="/agent/2">SYS.2 Analysis</a>
                <a class="nav-link px-2 {% if request.path == '/agent/3' %}active{% endif %}" href="/agent/3">SYS.2 Review</a>
                <a class="nav-link px-2 {% if request.path == '/agent/4' %}active{% endif %}" href="/agent/4">SYS.5 Testcase Generation</a>
            </div>
            <div class="form-check form-switch ms-auto">
                <input class="form-check-input" type="checkbox" id="darkModeToggle">
                <label class="form-check-label text-light" for="darkModeToggle">Dark Mode</label>
            </div>
        </div>
    </nav>

    <!-- Colored Tabs Navigation -->
    <!-- REMOVE Colored Tabs Navigation -->
    

    <div class="container-fluid py-4">
        <h2 class="mb-4">Agent 2 - SYS.2 Analysis</h2>
        <!-- SYS.1 Requirements Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">SYS.1 Requirements</h5>
                <div id="sys1RequirementsPlaceholder">
                     <p class="text-muted">SYS.1 requirements will load here after processing in Agent 1.</p>
                </div>
            </div>
        </div>
        <!-- Process Buttons and Status -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-end">
                <button class="btn btn-primary me-2" id="processAutomaticFileBtn">Process Automatic SYS.1 File</button>
                <button class="btn btn-secondary" id="showManualInputBtn">Manual Input (Upload/Text)</button>
                </div>
                <div class="mt-3 w-75 mx-auto">
                     <div class="alert alert-info d-none" id="processingStatusAgent2">Processing...</div>
                     <div class="progress mt-2 d-none" id="processingProgressBarAgent2">
                         <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
                     </div>
                 </div>
            </div>
        </div>
        <!-- Manual Input Section -->
        <div class="card mb-4" id="manualInputCard" style="display: none;">
            <div class="card-body">
                <h5 class="card-title">Manual Input (Upload or Text)</h5>
                <div class="mb-3">
                    <label for="fileInputAgent2" class="form-label">Upload Requirement File(s)</label>
                    <input class="form-control" type="file" id="fileInputAgent2" multiple>
                </div>
                <div class="mb-3">
                    <label for="rawContentAgent2" class="form-label">Paste Raw Content</label>
                    <textarea class="form-control" id="rawContentAgent2" rows="5"></textarea>
                </div>
                <button class="btn btn-primary" id="processManualInputBtn">Process Manual Input</button>
                <div class="mt-2 alert alert-info d-none" id="manualProcessingStatusAgent2">Processing...</div>
            </div>
        </div>
        <!-- Export Options Section -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                    <h5 class="card-title mb-0 me-3">Export Options</h5>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" onclick="exportRequirements('txt')">TXT</button>
                        <button class="btn btn-outline-primary" onclick="exportRequirements('docx')">DOCX</button>
                        <button class="btn btn-outline-primary" onclick="exportRequirements('xlsx')">XLSX</button>
                        <button class="btn btn-outline-primary" onclick="exportRequirements('csv')">CSV</button>
                        <button class="btn btn-outline-primary" onclick="exportRequirements('pdf')">PDF</button>
                    </div>
                    </div>
                    <a href="#sys2CombinedDashboardSection" class="btn btn-outline-secondary">Go to Traceability Dashboard</a>
                </div>
            </div>
        </div>
        <!-- Extracted SYS.2 Requirements Table Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Extracted SYS.2 Requirements</h5>
                <div id="sys2RequirementsTableContainer">
                    <p class="text-muted" id="sys2RequirementsPlaceholder">SYS.2 requirements will appear here after processing SYS.1 data.</p>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-bordered" id="sys2RequirementsTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th>SYS.1 Req. ID</th>
                                    <th>SYS.1 Requirement</th>
                                    <th>SYS.2 Req. ID</th>
                                    <th>SYS.2 System Requirement</th>
                                    <th>Type (Functional, Non-Functional)</th>
                                    <th>Verification Method (SYS.5)</th>
                                    <th>Verification Criteria</th>
                                    <th>Domain</th>
                                    <th>Rationale</th>
                                    <th>Requirement Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Table rows will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- SYS.2 Overall Status Chart -->
        <div class="card mb-4" id="sys2CombinedDashboardSection">
            <div class="card-body">
                <h5 class="card-title">SYS.2 Traceability and Status Dashboard - Status, Breakdowns, and Traceability</h5>
                <div class="row">
                    <div class="col-md-6">
                         <div class="card mb-3">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Overall Status (SYS.2)</h6>
                                <canvas id="sys2StatusChart"></canvas>
                                <p class="card-text text-center"><small class="text-muted">Total: <span id="totalSys2ReqsStatusChart">0</span> | Draft: <span id="draftSys2Count">0</span> | Reviewed: <span id="reviewedSys2Count">0</span> | Approved: <span id="approvedSys2Count">0</span> | Rejected: <span id="rejectedSys2Count">0</span> | Other: <span id="otherSys2Count">0</span></small></p>
                            </div>
                         </div>
                    </div>
                     <!-- SYS.2 Classification Breakdown Chart -->
                     <div class="col-md-6">
                          <div class="card mb-3">
                             <div class="card-body">
                                 <h6 class="card-subtitle mb-2 text-muted">Classification Breakdown (SYS.2)</h6>
                                 <canvas id="sys2TypeChart"></canvas>
                                 <p class="card-text text-center"><small class="text-muted">Total: <span id="totalSys2ReqsClassificationChart">0</span> | Functional: <span id="functionalSys2Count">0</span> | Non-Functional: <span id="nonFunctionalSys2Count">0</span> | Assumption: <span id="assumptionSys2Count">0</span> | Constraint: <span id="constraintSys2Count">0</span> | Other: <span id="otherSys2TypeCount">0</span></small></p>
                             </div>
                         </div>
                     </div>
                 </div>

                 <div class="row">
                      <!-- SYS.2 Verification Method Breakdown Chart -->
                     <div class="col-md-6">
                          <div class="card mb-3">
                             <div class="card-body">
                                 <h6 class="card-subtitle mb-2 text-muted">Verification Method Breakdown (SYS.2)</h6>
                                 <canvas id="sys2VerificationChart"></canvas>
                                 <p class="card-text text-center"><small class="text-muted">Total: <span id="totalSys2ReqsVerificationChart">0</span> | SQT: <span id="sqtSys2Count">0</span> | Test: <span id="testSys2Count">0</span> | Analysis: <span id="analysisSys2Count">0</span> | Inspection: <span id="inspectionSys2Count">0</span> | Default Test: <span id="testDefaultSys2Count">0</span> | Other: <span id="otherVerificationCount">0</span></small></p>
                             </div>
                         </div>
                     </div>
                     <!-- Moved Traceability Chart Here -->
                     <div class="col-md-6">
                          <div class="card mb-3">
                             <div class="card-body">
                                 <h6 class="card-subtitle mb-2 text-muted">Traceability Status (SYS.1 to SYS.2)</h6>
                                 <canvas id="sys2TraceabilityChart"></canvas>
                                 <p class="card-text text-center"><small class="text-muted">Total SYS.2 Requirements: <span id="totalSys2ReqsChart">0</span></small></p>
                             </div>
                         </div>
                    </div>
                 </div>

            </div>
        </div>

        <!-- SYS.1 to SYS.2 Traceability Table -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Traceability (SYS.1 to SYS.2)</h5>
                <div id="sys2TraceabilityTableContainer">
                    <p class="text-muted" id="sys2TraceabilityPlaceholder">SYS.1 to SYS.2 traceability data will appear here after processing.</p>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-bordered" id="sys2TraceabilityTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th>SYS.1 Req. ID</th>
                                    <th>SYS.2 Req. ID</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Table rows will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Agent 3 Feedback Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Feedback from Review (Agent 3)</h5>
                <div id="agent3Feedback">
                    <p class="text-muted">Feedback from Agent 3 will appear here.</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Toast Notification Container -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="exportToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">Export Status</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                Export completed successfully!
            </div>
        </div>
    </div>

    <!-- Dependencies Modal -->
    <div class="modal fade" id="dependenciesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Requirement Dependencies</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="dependenciesGraph" style="height: 400px;"></div>
                    <div id="dependenciesList" class="mt-3">
                        <h6>Dependencies List</h6>
                        <ul class="list-group" id="dependenciesListItems"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent 3 Feedback Modal -->
    <div class="modal fade" id="agent3FeedbackModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Review Feedback</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="feedbackContent"></div>
                    <div class="mt-3">
                        <h6>Compliance Results</h6>
                        <div id="complianceResults" class="mb-3"></div>
                        
                        <h6>Suggestions</h6>
                        <ul class="list-group" id="feedbackSuggestions"></ul>
                        
                        <h6 class="mt-3">Test Proposals</h6>
                        <ul class="list-group" id="testProposals"></ul>
                        
                        <div class="mt-3">
                            <h6>Suggest Improvement</h6>
                            <div class="mb-3">
                                <textarea class="form-control" id="improvementSuggestion" rows="3" placeholder="Enter your suggestion for improvement..."></textarea>
                            </div>
                            <button class="btn btn-primary" id="submitImprovement">Submit Suggestion</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.2/dist/vis-network.min.js"></script>
    <!-- Add a version query parameter to force browser cache refresh -->
    <script src="/static/js/agent2_dashboard.js?v=1.1"></script> <!-- Assuming script is in static/js -->
    <script>
        // JavaScript for Agent 2 Dashboard

        document.addEventListener('DOMContentLoaded', () => {
            const processAutomaticFileBtn = document.getElementById('processAutomaticFileBtn');
            const showManualInputBtn = document.getElementById('showManualInputBtn');
            const manualInputCard = document.getElementById('manualInputCard');
            const processManualInputBtn = document.getElementById('processManualInputBtn');
            const fileInput = document.getElementById('fileInputAgent2');
            const rawContentInput = document.getElementById('rawContentAgent2');
            const processingStatusDiv = document.getElementById('processingStatusAgent2');
            const manualProcessingStatusDiv = document.getElementById('manualProcessingStatusAgent2');
            const sys2RequirementsTableContainer = document.getElementById('sys2RequirementsTableContainer');
            const sys2RequirementsPlaceholder = document.getElementById('sys2RequirementsPlaceholder');
            const progressBar = document.getElementById('processingProgressBarAgent2');

            // Event listener for processing the automatic file
            processAutomaticFileBtn.addEventListener('click', () => {
                // Hide manual input section if visible
                manualInputCard.style.display = 'none';
                processInput('automatic_file');
            });

            // Event listener to show manual input section
            showManualInputBtn.addEventListener('click', () => {
                manualInputCard.style.display = 'block';
            });

            // Event listener for processing manual input
            processManualInputBtn.addEventListener('click', () => {
                processInput('manual_input');
            });


            // Function to handle input processing (either automatic file or manual input)
            function processInput(source) {
                let formData = new FormData();
                let hasInput = false;
                const statusDiv = source === 'automatic_file' ? processingStatusDiv : manualProcessingStatusDiv;

                if (source === 'automatic_file') {
                    formData.append('source', 'automatic_file');
                    hasInput = true;
                    statusDiv.textContent = 'Processing automatic SYS.1 file...';
                    statusDiv.classList.remove('d-none', 'alert-success', 'alert-danger');
                    statusDiv.classList.add('alert-info');
                     // manualProcessingStatusDiv.classList.add('d-none'); // Hide manual status if showing
                    sendToAgent2Process(formData, statusDiv);

                } else if (source === 'manual_input') {
                    const files = fileInput.files;
                    const rawContent = rawContentInput.value;

                    if (files.length === 0 && rawContent.trim() === '') {
                        alert('Please select a file or enter raw content.');
                        return;
                    }

                    for (const file of files) {
                        formData.append('file', file);
                    }
                    formData.append('raw_content', rawContent);
                    hasInput = true;

                    statusDiv.textContent = 'Uploading and processing manual input...';
                    statusDiv.classList.remove('d-none', 'alert-success', 'alert-danger');
                    statusDiv.classList.add('alert-info');
                     // processingStatusDiv.classList.add('d-none'); // Hide automatic status if showing
                    progressBar.classList.remove('d-none'); // Show progress bar

                    // --- Send manual input to /api/upload first (like Agent 1) ---
                    fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            statusDiv.textContent = 'Upload successful. Processing SYS.1 requirements...';
                            // --- Now trigger Agent 2's main processing which reads from session ---
                            // Agent 2's /api/agent2/process should be updated to primarily read from session if possible,
                            // or we can pass a flag. For now, let's just call it without formData
                            // and ensure the backend reads from session if no file/raw_content is provided.
                            // A better approach is to explicitly tell the backend to process session data.
                            
                            // Let's adjust the call to /api/agent2/process to indicate it should read from session
                            // This requires a minor change in app.py's /api/agent2/process logic as well.
                            // For now, let's send a dummy payload or rely on the backend to check session first.
                            // A simple approach for now is to call it without body, assuming backend reads session.

                             // Let's assume the backend /api/agent2/process, when called without file/raw_content
                             // and with source='session', will read from session.
                            const agent2ProcessFormData = new FormData();
                            agent2ProcessFormData.append('source', 'session'); // Indicate source is session
                            sendToAgent2Process(agent2ProcessFormData, statusDiv); // Call Agent 2 process with session source

                        } else {
                            statusDiv.classList.remove('alert-info', 'alert-success');
                            statusDiv.classList.add('alert-danger');
                            statusDiv.textContent = 'Upload Error: ' + (data.message || 'Unknown error');
                            if (sys2RequirementsPlaceholder) sys2RequirementsPlaceholder.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        statusDiv.classList.remove('alert-info', 'alert-success');
                        statusDiv.classList.add('alert-danger');
                        statusDiv.textContent = 'Upload Fetch Error: ' + error.message;
                         if (sys2RequirementsPlaceholder) sys2RequirementsPlaceholder.style.display = 'block';
                    });

                }

                if (!hasInput) return;

                // Hide initial placeholder
                if (sys2RequirementsPlaceholder) sys2RequirementsPlaceholder.style.display = 'none';
                // Clear previous results
                const table = document.getElementById('sys2RequirementsTable');
                const tbody = table.querySelector('tbody');
                tbody.innerHTML = '';
            }

            // Function to send data to /api/agent2/process
            function sendToAgent2Process(formData, statusDiv) {
                progressBar.classList.remove('d-none'); // Show progress bar

                fetch('/api/agent2/process', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    progressBar.classList.add('d-none'); // Hide progress bar on completion
                    if (data.status === 'success') {
                        statusDiv.textContent = data.message || 'Processing successful.';

                        // Display SYS.2 requirements and other data
                        displaySys2Requirements(data.sys2_requirements);
                        // displayDependencies(data.dependencies); // Implement this function
                        // displayClassification(data.classification); // Implement this function
                        // displayVerificationMapping(data.verification_mapping); // Implement this function

                        // --- Call function to update dashboard charts and summary ---
                        fetchAndDisplayCombinedDashboardSummary();
                        // -------------------------------------------------------------

                        // --- Automatically trigger XLSX export after successful processing ---
                        // Call the new backend endpoint to save the file on the server
                        // Removed automatic save functionality as requested
                        /*
                        fetch('/api/agent2/save_sys2_xlsx', {
                            method: 'POST', // Use POST as defined in app.py
                            headers: {
                                'Content-Type': 'application/json', // Specify content type if sending a body, though this endpoint doesn't require one yet
                            },
                            // No body needed for this endpoint as it reads from session
                        })
                        .then(saveResponse => saveResponse.json())
                        .then(saveData => {
                            // Show a toast notification based on the save outcome
                            const toastEl = document.getElementById('exportToast');
                            const toast = new bootstrap.Toast(toastEl, {
                                delay: 5000 // Show for 5 seconds
                            });
                            
                            if (saveData.status === 'success') {
                                toastEl.querySelector('.toast-body').textContent = saveData.message || 'File saved successfully!';
                                // Make the toast background green for success
                                toastEl.classList.remove('bg-danger');
                                toastEl.classList.add('bg-success');

                            } else {
                                toastEl.querySelector('.toast-body').textContent = saveData.message || 'Failed to save file.';
                                // Make the toast background red for error
                                toastEl.classList.remove('bg-success');
                                toastEl.classList.add('bg-danger');
                            }
                            toast.show();
                        })
                        .catch(saveError => {
                            console.error('Error saving file on backend:', saveError);
                            const toastEl = document.getElementById('exportToast');
                            const toast = new bootstrap.Toast(toastEl, {
                                delay: 5000 // Show for 5 seconds
                            });
                            toastEl.querySelector('.toast-body').textContent = 'Error saving file: ' + saveError.message;
                             // Make the toast background red for error
                            toastEl.classList.remove('bg-success');
                            toastEl.classList.add('bg-danger');
                            toast.show();
                        });
                        */
                        // -------------------------------------------------------------------

                    } else {
                        statusDiv.classList.remove('alert-info', 'alert-success');
                        statusDiv.classList.add('alert-danger');
                        statusDiv.textContent = 'Error: ' + (data.message || 'Unknown error');
                        // Show placeholder if there's an error
                         if (sys2RequirementsPlaceholder) sys2RequirementsPlaceholder.style.display = 'block';
                    }
                })
                .catch(error => {
                    progressBar.classList.add('d-none'); // Hide progress bar on error
                    statusDiv.classList.remove('alert-info', 'alert-success');
                    statusDiv.classList.add('alert-danger');
                    statusDiv.textContent = 'Fetch Error: ' + error.message;
                     // Show placeholder on fetch error
                     if (sys2RequirementsPlaceholder) sys2RequirementsPlaceholder.style.display = 'block';
                });
            }

            // Function to display SYS.2 requirements
            function displaySys2Requirements(requirements) {
                const container = document.getElementById('sys2RequirementsTableContainer');
                const placeholder = document.getElementById('sys2RequirementsPlaceholder');
                const table = document.getElementById('sys2RequirementsTable');
                const tbody = table.querySelector('tbody');

                // Define a character limit for collapsing
                const collapseThreshold = 150; // Adjust as needed

                // Clear previous results
                tbody.innerHTML = '';

                if (!requirements || requirements.length === 0) {
                    placeholder.style.display = 'block';
                    table.style.display = 'none';
                    return;
                }

                placeholder.style.display = 'none';
                table.style.display = 'table';

                requirements.forEach(req => {
                    const row = tbody.insertRow();
                    row.dataset.sys2Id = req.sys2_id; // Store SYS.2 ID on the row

                    // Helper function to create a cell with collapsible text
                    function createCollapsibleCell(text) {
                        const cell = row.insertCell();
                        const textContent = text || '';
                        
                        if (textContent.length > collapseThreshold) {
                            const containerDiv = document.createElement('div');
                            containerDiv.classList.add('collapsible-text-container');
                            containerDiv.textContent = textContent;

                            const toggleLink = document.createElement('a');
                            toggleLink.href = '#';
                            toggleLink.classList.add('show-more-toggle');
                            toggleLink.textContent = 'Show more';

                            toggleLink.addEventListener('click', (e) => {
                                e.preventDefault();
                                containerDiv.classList.toggle('expanded');
                                if (containerDiv.classList.contains('expanded')) {
                                    toggleLink.textContent = 'Show less';
                                } else {
                                    toggleLink.textContent = 'Show more';
                                }
                            });

                            cell.appendChild(containerDiv);
                            cell.appendChild(toggleLink);
                        } else {
                            cell.textContent = textContent;
                        }
                        return cell;
                    }

                    // Cells - ensure order matches table headers and use helper for long text columns
                    row.insertCell(0).textContent = req.sys1_id || '';
                    createCollapsibleCell(req.sys1_requirement).dataset.field = 'sys1_requirement'; // SYS.1 Requirement - Make collapsible
                    row.insertCell(2).textContent = req.sys2_id || '';

                    // Make SYS.2 System Requirement editable and potentially collapsible (handled by edit logic)
                    const sys2ReqCell = createCollapsibleCell(req.sys2_requirement);
                    sys2ReqCell.dataset.field = 'sys2_requirement'; // Mark for editing
                    // Note: Edit logic will need adjustment to handle the wrapper div
                    row.appendChild(sys2ReqCell); // Append the created cell to the row

                    row.insertCell(4).textContent = req.classification || '';
                    row.insertCell(5).textContent = req.verification_mapping || '';

                    createCollapsibleCell(req.verification_criteria).dataset.field = 'verification_criteria'; // Verification Criteria - Make collapsible

                    row.insertCell(7).textContent = req.domain || '';

                    // Rationale (originally 9, now 8) - Make collapsible
                    createCollapsibleCell(req.rationale).dataset.field = 'rationale'; // Rationale - Make collapsible

                    // Requirement Status (originally 10, now 9)
                    row.insertCell(9).textContent = req.req_status || '';

                    // Actions Cell
                    const actionsCell = row.insertCell(10);

                    // Initially show only Edit button
                    actionsCell.innerHTML = `
                        <button class="btn btn-sm btn-primary edit-btn">Edit</button>
                        <button class="btn btn-sm btn-success save-btn" style="display: none;">Save</button>
                        <button class="btn btn-sm btn-secondary cancel-btn" style="display: none;">Cancel</button>
                    `;

                    // Add event listeners to buttons
                    actionsCell.querySelector('.edit-btn').addEventListener('click', handleEditClick);
                    actionsCell.querySelector('.save-btn').addEventListener('click', handleSaveClick);
                    actionsCell.querySelector('.cancel-btn').addEventListener('click', handleCancelClick);
                });
            }

            // Store original requirement data for cancelling edits
            let originalRequirementData = {};

            // Handle Edit button click
            function handleEditClick(event) {
                console.log('Edit button clicked', event.target);
                const row = event.target.closest('tr');
                const sys2Id = row.dataset.sys2Id;
                console.log('Editing requirement with SYS.2 ID:', sys2Id);

                // Store original data before editing
                originalRequirementData[sys2Id] = {
                    // Target the collapsible text container if it exists, otherwise the cell text
                    sys2_requirement: row.cells[3].querySelector('.collapsible-text-container')?.textContent.trim() || row.cells[3].textContent.trim(),
                    // Rationale is now at index 8 - only store text, not editable currently
                    rationale: row.cells[8].querySelector('.collapsible-text-container')?.textContent.trim() || row.cells[8].textContent.trim()
                    // Requirement Status is now at index 9
                    // req_status: row.cells[9].textContent.trim() // Status is not editable per current UI
                    // Add other editable fields here if any
                };
                console.log('Stored original data:', originalRequirementData[sys2Id]);

                // Enable editing for relevant cells
                const sys2ReqCellContent = row.cells[3].querySelector('.collapsible-text-container') || row.cells[3]; // Get the container or the cell
                sys2ReqCellContent.contentEditable = true; // SYS.2 System Requirement
                sys2ReqCellContent.classList.add('editable'); // Add a class for styling if needed

                // Hide the toggle link if it exists during editing
                const sys2ReqToggle = row.cells[3].querySelector('.show-more-toggle');
                if (sys2ReqToggle) {
                    sys2ReqToggle.style.display = 'none';
                }


                // Show Save/Cancel buttons, hide Edit button (Deps/Feedback already hidden)
                row.querySelector('.edit-btn').style.display = 'none';
                row.querySelector('.save-btn').style.display = 'inline-block';
                row.querySelector('.cancel-btn').style.display = 'inline-block';
            }

            // Handle Save button click
            function handleSaveClick(event) {
                console.log('Save button clicked', event.target);
                const row = event.target.closest('tr');
                const sys2Id = row.dataset.sys2Id;
                console.log('Saving requirement with SYS.2 ID:', sys2Id);

                // Collect updated data
                const sys2ReqCellContent = row.cells[3].querySelector('.collapsible-text-container') || row.cells[3]; // Get the container or the cell

                const updatedData = {
                    sys2_requirement: sys2ReqCellContent.textContent.trim(),
                    // Rationale is now at index 8 - not editable currently
                    rationale: row.cells[8].querySelector('.collapsible-text-container')?.textContent.trim() || row.cells[8].textContent.trim()
                    // Requirement Status is now at index 9
                    // req_status: row.cells[9].textContent.trim() // Status is not editable per current UI
                    // Collect other editable fields here if any
                };
                 console.log('Collected updated data:', updatedData);

                // Send update to backend
                updateRequirement(sys2Id, updatedData);

                // Disable editing and restore button states
                disableEditing(row);
            }

            // Handle Cancel button click
            function handleCancelClick(event) {
                console.log('Cancel button clicked', event.target);
                const row = event.target.closest('tr');
                const sys2Id = row.dataset.sys2Id;
                console.log('Cancelling edit for requirement with SYS.2 ID:', sys2Id);

                // Restore original data
                if (originalRequirementData[sys2Id]) {
                    const sys2ReqCellContent = row.cells[3].querySelector('.collapsible-text-container') || row.cells[3]; // Get the container or the cell
                    sys2ReqCellContent.textContent = originalRequirementData[sys2Id].sys2_requirement;
                    // Rationale is now at index 8
                    // row.cells[8].textContent = originalRequirementData[sys2Id].rationale; // Rationale is not editable
                     // Restore other editable fields if any

                    // Remove original data from storage
                    delete originalRequirementData[sys2Id];
                }

                // Disable editing and restore button states
                disableEditing(row);
            }

            // Helper function to disable editing and reset button states
            function disableEditing(row) {
                console.log('Disabling editing for row:', row);

                const sys2ReqCellContent = row.cells[3].querySelector('.collapsible-text-container') || row.cells[3]; // Get the container or the cell
                sys2ReqCellContent.contentEditable = false;
                sys2ReqCellContent.classList.remove('editable');

                 // Show the toggle link again if it exists
                const sys2ReqToggle = row.cells[3].querySelector('.show-more-toggle');
                if (sys2ReqToggle) {
                    sys2ReqToggle.style.display = 'block';
                     // Ensure the container is collapsed when editing finishes
                    sys2ReqCellContent.classList.remove('expanded');
                    // Update toggle link text back to 'Show more'
                    sys2ReqToggle.textContent = 'Show more';
                }


                row.querySelector('.edit-btn').style.display = 'inline-block';
                row.querySelector('.save-btn').style.display = 'none';
                row.querySelector('.cancel-btn').style.display = 'none';
            }

            // Function to send update request to the backend (Already partially implemented)
            async function updateRequirement(sys2Id, updates) {
                console.log('Sending update request for SYS.2 ID:', sys2Id, 'with updates:', updates);
                // Ensure this matches the endpoint in app.py
                const url = `/api/agent2/update_requirement`; 

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            id: sys2Id, // Use 'id' as expected by the backend
                            updates: updates,
                        }),
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Failed to update requirement');
                    }

                    const result = await response.json();
                    console.log('Update successful:', result);
                    // Optionally, show a success message to the user

                } catch (error) {
                    console.error('Error updating requirement:', error);
                    // Optionally, show an error message to the user
                    // You might want to revert the changes in the UI if the save fails
                    // This would require storing the original state more robustly or refetching.
                }
            }

            // Function to export requirements
            function exportRequirements(format) {
                console.log(`Exporting SYS.2 requirements in ${format} format.`);
                fetch(`/api/agent2/export/${format}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Export failed');
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        // Create a temporary URL for the blob
                        const url = window.URL.createObjectURL(blob);
                        
                        // Create a temporary link element
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = `sys2_requirements.${format}`;
                        
                        // Append to body, click, and remove
                        document.body.appendChild(a);
                        a.click();
                        
                        // Clean up
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        // Show success toast
                        const toastEl = document.getElementById('exportToast');
                        const toast = new bootstrap.Toast(toastEl, {
                            delay: 3000 // Show for 3 seconds
                        });
                        toastEl.querySelector('.toast-body').textContent = 'Export completed successfully!';
                        toast.show();
                    })
                    .catch(error => {
                        console.error('Error exporting:', error);
                        // Show error toast
                        const toastEl = document.getElementById('exportToast');
                        const toast = new bootstrap.Toast(toastEl, {
                            delay: 3000 // Show for 3 seconds
                        });
                        toastEl.querySelector('.toast-body').textContent = 'Export failed: ' + error.message;
                        toast.show();
                    });
            }

            // Function to show dependencies in modal
            function showDependencies(sys2Id, dependencies) {
                const modal = new bootstrap.Modal(document.getElementById('dependenciesModal'));
                const graphContainer = document.getElementById('dependenciesGraph');
                const listContainer = document.getElementById('dependenciesListItems');
                
                // Clear previous content
                listContainer.innerHTML = '';
                
                // Create nodes and edges for the graph
                const nodes = new vis.DataSet([
                    { id: sys2Id, label: sys2Id, color: '#28a745' } // Current requirement
                ]);
                const edges = new vis.DataSet();
                
                // Add dependencies to the graph and list
                dependencies.forEach(dep => {
                    nodes.add({ id: dep.to, label: dep.to });
                    edges.add({ from: dep.from, to: dep.to, label: dep.label });
                    
                    // Add to list
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.textContent = `${dep.from}  ${dep.to} (${dep.label})`;
                    listContainer.appendChild(li);
                });
                
                // Create the network
                const data = { nodes, edges };
                const options = {
                    nodes: {
                        shape: 'box',
                        margin: 10,
                        font: { size: 14 }
                    },
                    edges: {
                        arrows: 'to',
                        font: { size: 12 }
                    },
                    layout: {
                        hierarchical: {
                            direction: 'LR',
                            sortMethod: 'directed'
                        }
                    }
                };
                
                new vis.Network(graphContainer, data, options);
                modal.show();
            }

            // Function to show Agent 3 feedback
            function showAgent3Feedback(sys2Id) {
                const modal = new bootstrap.Modal(document.getElementById('agent3FeedbackModal'));
                const feedbackContent = document.getElementById('feedbackContent');
                const suggestionsList = document.getElementById('feedbackSuggestions');
                const complianceResults = document.getElementById('complianceResults');
                const testProposals = document.getElementById('testProposals');
                const improvementSuggestion = document.getElementById('improvementSuggestion');
                const submitImprovement = document.getElementById('submitImprovement');
                
                // Clear previous content
                feedbackContent.innerHTML = '';
                suggestionsList.innerHTML = '';
                complianceResults.innerHTML = '';
                testProposals.innerHTML = '';
                improvementSuggestion.value = '';
                
                // Fetch feedback from Agent 3
                fetch(`/api/agent3/review/${sys2Id}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Display review status
                            feedbackContent.innerHTML = `
                                <div class="alert alert-info">
                                    <h6>Review Status</h6>
                                    <p>${data.review_status || 'Pending review'}</p>
                                </div>
                            `;
                            
                            // Display compliance results
                            if (data.compliance_results && data.compliance_results.length > 0) {
                                const complianceHtml = data.compliance_results.map(result => `
                                    <div class="alert ${result.status === 'Pass' ? 'alert-success' : 'alert-warning'}">
                                        <strong>${result.rule}</strong>: ${result.description}
                                    </div>
                                `).join('');
                                complianceResults.innerHTML = complianceHtml;
                            } else {
                                complianceResults.innerHTML = '<p class="text-muted">No compliance results available</p>';
                            }
                            
                            // Display suggestions
                            if (data.suggestions && data.suggestions.length > 0) {
                                data.suggestions.forEach(suggestion => {
                                    const li = document.createElement('li');
                                    li.className = 'list-group-item';
                                    li.textContent = suggestion;
                                    suggestionsList.appendChild(li);
                                });
                            } else {
                                suggestionsList.innerHTML = '<li class="list-group-item">No suggestions available</li>';
                            }
                            
                            // Display test proposals
                            if (data.test_proposals && data.test_proposals.length > 0) {
                                data.test_proposals.forEach(proposal => {
                                    const li = document.createElement('li');
                                    li.className = 'list-group-item';
                                    li.innerHTML = `
                                        <strong>${proposal.title}</strong>
                                        <p class="mb-0">${proposal.description}</p>
                                    `;
                                    testProposals.appendChild(li);
                                });
                            } else {
                                testProposals.innerHTML = '<li class="list-group-item">No test proposals available</li>';
                            }
                            
                            // Set up submit improvement handler
                            submitImprovement.onclick = () => {
                                const suggestion = improvementSuggestion.value.trim();
                                if (!suggestion) {
                                    alert('Please enter a suggestion');
                                    return;
                                }
                                
                                // Submit the suggestion
                                fetch('/api/agent3/apply-suggestion', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        requirement_id: sys2Id,
                                        suggestion: suggestion
                                    })
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.status === 'success') {
                                        alert('Suggestion submitted successfully');
                                        improvementSuggestion.value = '';
                                        // Optionally refresh the feedback
                                        showAgent3Feedback(sys2Id);
                                    } else {
                                        alert('Error submitting suggestion: ' + data.message);
                                    }
                                })
                                .catch(error => {
                                    alert('Error submitting suggestion: ' + error.message);
                                });
                            };
                        } else {
                            feedbackContent.innerHTML = `
                                <div class="alert alert-warning">
                                    <p>No feedback available yet. This requirement is pending review.</p>
                                </div>
                            `;
                        }
                        modal.show();
                    })
                    .catch(error => {
                        feedbackContent.innerHTML = `
                            <div class="alert alert-danger">
                                <p>Error fetching feedback: ${error.message}</p>
                            </div>
                        `;
                        modal.show();
                    });
            }

            // Dark Mode Toggle Logic (Keep this separate or merge carefully)
            const darkModeToggle = document.getElementById('darkModeToggle');
            const body = document.body;

            // Load saved preference
            const savedMode = localStorage.getItem('darkMode');
            if (savedMode) {
                body.classList.toggle('dark-mode', savedMode === 'enabled');
                if (savedMode === 'enabled') {
                    darkModeToggle.checked = true;
                }
            }

            darkModeToggle.addEventListener('change', function() {
                if (this.checked) {
                    body.classList.add('dark-mode');
                    localStorage.setItem('darkMode', 'enabled');
                } else {
                    body.classList.remove('dark-mode');
                    localStorage.setItem('darkMode', 'disabled');
                }
            });

        }); // End DOMContentLoaded

        // --- Combined Dashboard Summary & Chart Rendering ---
        // Function to fetch and display combined dashboard summary
        async function fetchAndDisplayCombinedDashboardSummary() {
            console.log("Fetching combined dashboard summary...");
            try {
                const response = await fetch('/api/agent2/combined_dashboard_summary');
                const data = await response.json();

                if (data.status === 'success') {
                    console.log("Combined Dashboard summary fetched successfully:", data.summary);
                    const sys1Summary = data.summary?.sys1 || {}; // Keep sys1Summary variable for potential future use/traceability table
                    const sys2Summary = data.summary?.sys2 || {};

                    // Update SYS.2 summary statistics text (using new chart-specific IDs)
                    // Ensure all IDs here match the HTML span elements added in the last step
                    const totalSys2ReqsChartElement = document.getElementById('totalSys2ReqsChart');
                    if (totalSys2ReqsChartElement) totalSys2ReqsChartElement.textContent = sys2Summary.total_sys2_reqs || 0;

                    const totalSys2ReqsStatusChartElement = document.getElementById('totalSys2ReqsStatusChart');
                    if (totalSys2ReqsStatusChartElement) totalSys2ReqsStatusChartElement.textContent = sys2Summary.total_sys2_reqs || 0;

                    const totalSys2ReqsClassificationChartElement = document.getElementById('totalSys2ReqsClassificationChart');
                    if (totalSys2ReqsClassificationChartElement) totalSys2ReqsClassificationChartElement.textContent = sys2Summary.total_sys2_reqs || 0;

                     const totalSys2ReqsVerificationChartElement = document.getElementById('totalSys2ReqsVerificationChart');
                     if (totalSys2ReqsVerificationChartElement) totalSys2ReqsVerificationChartElement.textContent = sys2Summary.total_sys2_reqs || 0;

                    // Update specific count spans for Overall Status
                    const tracedToSys1Element = document.getElementById('tracedToSys1');
                     if (tracedToSys1Element) tracedToSys1Element.textContent = sys2Summary.traced_to_sys1 || 0;

                    const notTracedToSys1Element = document.getElementById('notTracedToSys1');
                     if (notTracedToSys1Element) notTracedToSys1Element.textContent = sys2Summary.not_traced_to_sys1 || 0;

                    const draftSys2CountElement = document.getElementById('draftSys2Count');
                    if (draftSys2CountElement) draftSys2CountElement.textContent = sys2Summary.status_breakdown?.Draft || 0;

                    const reviewedSys2CountElement = document.getElementById('reviewedSys2Count');
                    if (reviewedSys2CountElement) reviewedSys2CountElement.textContent = sys2Summary.status_breakdown?.Reviewed || 0;

                    const approvedSys2CountElement = document.getElementById('approvedSys2Count');
                    if (approvedSys2CountElement) approvedSys2CountElement.textContent = sys2Summary.status_breakdown?.Approved || 0;

                    const rejectedSys2CountElement = document.getElementById('rejectedSys2Count');
                    if (rejectedSys2CountElement) rejectedSys2CountElement.textContent = sys2Summary.status_breakdown?.Rejected || 0;

                    const sys2OtherStatusCountElement = document.getElementById('otherSys2Count');
                    if(sys2OtherStatusCountElement) sys2OtherStatusCountElement.textContent = sys2Summary.status_breakdown?.Other || 0;

                    // Update specific count spans for Classification Breakdown
                    const functionalSys2CountElement = document.getElementById('functionalSys2Count');
                     if(functionalSys2CountElement) functionalSys2CountElement.textContent = sys2Summary.classification_breakdown?.Functional || 0;

                    const nonFunctionalSys2CountElement = document.getElementById('nonFunctionalSys2Count');
                     if(nonFunctionalSys2CountElement) nonFunctionalSys2CountElement.textContent = sys2Summary.classification_breakdown?.Non_Functional || 0;

                     const assumptionSys2CountElement = document.getElementById('assumptionSys2Count');
                     if(assumptionSys2CountElement) assumptionSys2CountElement.textContent = sys2Summary.classification_breakdown?.Assumption || 0;

                     const constraintSys2CountElement = document.getElementById('constraintSys2Count');
                     if(constraintSys2CountElement) constraintSys2CountElement.textContent = sys2Summary.classification_breakdown?.Constraint || 0;

                    const sys2OtherTypeCountElement = document.getElementById('otherSys2TypeCount');
                    if(sys2OtherTypeCountElement) sys2OtherTypeCountElement.textContent = sys2Summary.classification_breakdown?.Other || 0;

                    // Update specific count spans for Verification Method Breakdown
                    const sqtSys2CountElement = document.getElementById('sqtSys2Count');
                    if(sqtSys2CountElement) sqtSys2CountElement.textContent = sys2Summary.verification_breakdown?.['System Qualification Test (SYS.5)'] || 0;

                    const testSys2CountElement = document.getElementById('testSys2Count');
                    if(testSys2CountElement) testSys2CountElement.textContent = sys2Summary.verification_breakdown?.Test || 0;

                    const analysisSys2CountElement = document.getElementById('analysisSys2Count');
                    if(analysisSys2CountElement) analysisSys2CountElement.textContent = sys2Summary.verification_breakdown?.Analysis || 0;

                    const inspectionSys2CountElement = document.getElementById('inspectionSys2Count');
                    if(inspectionSys2CountElement) inspectionSys2CountElement.textContent = sys2Summary.verification_breakdown?.Inspection || 0;

                    const testDefaultSys2CountElement = document.getElementById('testDefaultSys2Count');
                    if(testDefaultSys2CountElement) testDefaultSys2CountElement.textContent = sys2Summary.verification_breakdown?.['Test (Default)'] || 0;

                    const sys2OtherVerificationCountElement = document.getElementById('otherVerificationCount');
                    if(sys2OtherVerificationCountElement) sys2OtherVerificationCountElement.textContent = sys2Summary.verification_breakdown?.Other || 0;

                    // Render Charts (using new chart IDs)
                    renderChart('sys2TraceabilityChart', ['Traced to SYS.1', 'Not Traced to SYS.1'], [sys2Summary.traced_to_sys1 || 0, sys2Summary.not_traced_to_sys1 || 0], ['#007bff', '#ffc107']);
                    renderChart('sys2StatusChart', Object.keys(sys2Summary.status_breakdown || {}), Object.values(sys2Summary.status_breakdown || {}), ['#ffc107', '#17a2b8', '#28a745', '#dc3545', '#6c757d']); // Yellow (Draft), Info (Reviewed), Green (Approved), Red (Rejected), Secondary (Other)
                    renderChart('sys2TypeChart', Object.keys(sys2Summary.classification_breakdown || {}), Object.values(sys2Summary.classification_breakdown || {}), ['#28a745', '#007bff', '#ffc107', '#dc3545', '#6c757d']); // Green (Functional), Blue (Non-Functional), Yellow (Assumption), Red (Constraint), Secondary (Other)
                    renderChart('sys2VerificationChart', Object.keys(sys2Summary.verification_breakdown || {}), Object.values(sys2Summary.verification_breakdown || {}), ['#17a2b8', '#007bff', '#28a745', '#ffc107', '#6c757d', '#dc3545']); // Info (SQT), Blue (Test), Green (Analysis), Yellow (Inspection), Secondary (Other), Red (Default/Unexpected)

                    // Display Traceability Table
                    displaySys2TraceabilityTable(sys1Summary.sys1_requirements || [], sys2Summary.sys2_requirements || []);

                } else {
                    console.error("Error fetching combined dashboard summary:", data.message);
                }
            } catch (error) {
                console.error("Fetch error for combined dashboard summary:", error);
            }
        }

        // Generic function to render a pie chart
        let chartInstances = {}; // Store chart instances by id
        function renderChart(canvasId, labels, data, colors) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) {
                console.error(`Canvas element with ID ${canvasId} not found.`);
                return;
            }

            // Destroy existing chart if it exists
            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }

            chartInstances[canvasId] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                             labels: {
                                 color: document.body.classList.contains('dark-mode') ? '#f8f9fa' : '#212529' // Adjust legend text color based on mode
                             }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    return tooltipItem.label + ': ' + tooltipItem.raw;
                                }
                            }
                        }
                    }
                },
            });
             // Add a handler for dark mode toggle to update chart legend color
             document.getElementById('darkModeToggle').addEventListener('change', () => {
                 if (chartInstances[canvasId] && chartInstances[canvasId].options.plugins.legend.labels) {
                      chartInstances[canvasId].options.plugins.legend.labels.color = document.body.classList.contains('dark-mode') ? '#f8f9fa' : '#212529';
                      chartInstances[canvasId].update();
                 }
             });
        }

        // Function to display SYS.1 to SYS.2 traceability table
        function displaySys2TraceabilityTable(sys1Reqs, sys2Reqs) {
            console.log("TRACE_TABLE: Attempting to display SYS.1 to SYS.2 traceability table.");
            console.log("TRACE_TABLE: SYS.1 Req Data Received:", sys1Reqs);
            console.log("TRACE_TABLE: SYS.2 Req Data Received:", sys2Reqs);

            const table = document.getElementById('sys2TraceabilityTable');
            const tableBody = table ? table.querySelector('tbody') : null;
            const placeholder = document.getElementById('sys2TraceabilityPlaceholder');

            if (!table || !tableBody || !placeholder) {
                console.error("Traceability table elements not found.");
                return;
            }

            // Clear existing rows
            tableBody.innerHTML = '';

            if (!sys1Reqs || sys1Reqs.length === 0 || !sys2Reqs || sys2Reqs.length === 0) {
                placeholder.style.display = 'block';
                table.style.display = 'none';
                console.log("No data for traceability table, showing placeholder.");
                return;
            }

            placeholder.style.display = 'none';
            table.style.display = 'table'; // Show the table

            // Create a map of SYS.1 requirements for easier lookup by sys1_id
            const sys1Map = {};
            sys1Reqs.forEach(req => {
                if (req.sys1_id) {
                    sys1Map[req.sys1_id] = req;
                }
            });

            // Iterate through SYS.2 requirements and find their corresponding SYS.1 requirements
            sys2Reqs.forEach(sys2Req => {
                // Assuming sys2Req has a field linking it back to SYS.1, e.g., 'sys1_id'
                const sys1Id = sys2Req.sys1_id;
                console.log(`TRACE_TABLE: Processing SYS.2 Req ID: ${sys2Req.sys2_id}, Linked SYS.1 ID: ${sys1Id}`);

                const row = tableBody.insertRow();
                const sys1Cell = row.insertCell(0);
                const sys2Cell = row.insertCell(1);

                sys2Cell.textContent = sys2Req.sys2_id || '';

                if (sys1Id) {
                    // Find the corresponding SYS.1 requirement (optional - just displaying ID for now)
                    // const sys1Req = sys1Map[sys1Id];
                    sys1Cell.textContent = sys1Id;
                    console.log(`TRACE_TABLE: Added row for SYS.1 ${sys1Id} and SYS.2 ${sys2Req.sys2_id}`);
                } else {
                    // Handle SYS.2 requirements that are not traced to any SYS.1 requirement
                    sys1Cell.textContent = 'Untraced';
                    console.log(`TRACE_TABLE: Added row for untraced SYS.2 ${sys2Req.sys2_id}`);
                }
            });
             console.log("TRACE_TABLE: Traceability table population finished.");
        }

        // Fetch and display combined summary on page load
        document.addEventListener('DOMContentLoaded', fetchAndDisplayCombinedDashboardSummary);

        // Modify the handleProcessResponse function to also update the dashboard and traceability table
        // Find the existing handleProcessResponse function
        const originalHandleProcessResponse = window.handleProcessResponse;
        window.handleProcessResponse = function(data) {
            console.log("handleProcessResponse triggered.");
            // Call the original function first
            // This function currently displays SYS.2 requirements in the main table
            if (typeof originalHandleProcessResponse === 'function') {
                 originalHandleProcessResponse(data);
            } else {
                 // If originalHandleProcessResponse is not found (e.g., script loading issue),
                 // manually display SYS.2 requirements if they are in the data.
                 if (data && data.sys2_requirements) {
                      displaySys2Requirements(data.sys2_requirements);
                 }
            }

            // Then fetch and display the updated dashboard summary and traceability table
            // The combined dashboard summary endpoint should return both sys1 and sys2 requirements for the table
            fetch('/api/agent2/combined_dashboard_summary')
                .then(response => response.json())
                .then(summaryData => {
                    if (summaryData.status === 'success') {
                        console.log("Combined Dashboard summary fetched for table population.", summaryData);
                        // Update charts (already handled in fetchAndDisplayCombinedDashboardSummary)
                        // ... chart rendering logic ...

                        // Display Traceability Table using data from combined_dashboard_summary
                        displaySys2TraceabilityTable(summaryData.summary?.sys1_requirements || [], summaryData.summary?.sys2_requirements || []);
                    } else {
                        console.error("Error fetching combined dashboard summary for table:", summaryData.message);
                    }
                })
                .catch(error => {
                    console.error("Fetch error for combined dashboard summary (for table):", error);
                });
        };
        // --- End Combined Dashboard Summary & Chart Rendering ---

        // Function to trigger XLSX export automatically after SYS.2 requirements are generated
        function autoExportSys2Requirements() {
            fetch('/api/agent2/export/xlsx')
                .then(response => {
                    if (!response.ok) throw new Error('Export failed');
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = 'sys2_requirements.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showExportToast('SYS.2 requirements exported successfully!');
                })
                .catch(error => {
                    showExportToast('Export failed: ' + error.message, true);
                });
        }

        // Function to show a toast notification
        function showExportToast(message, isError) {
            let toast = document.getElementById('exportToast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'exportToast';
                toast.className = 'toast position-fixed bottom-0 end-0 m-3';
                toast.setAttribute('role', 'alert');
                toast.setAttribute('aria-live', 'assertive');
                toast.setAttribute('aria-atomic', 'true');
                toast.innerHTML = `<div class="toast-header"><strong class="me-auto">Export Status</strong><button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button></div><div class="toast-body"></div>`;
                document.body.appendChild(toast);
            }
            toast.querySelector('.toast-body').textContent = message;
            toast.classList.remove('bg-danger', 'bg-success');
            toast.classList.add(isError ? 'bg-danger' : 'bg-success');
            const bsToast = new bootstrap.Toast(toast, { delay: 4000 });
            bsToast.show();
        }

    </script>
</body>
</html>
{% endblock %} 